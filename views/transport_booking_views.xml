<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ============================================ -->
    <!-- VUES POUR LES R√âSERVATIONS -->
    <!-- ============================================ -->

    <!-- Vue Tree -->
    <record id="transport_booking_view_tree" model="ir.ui.view">
        <field name="name">transport.booking.view.tree</field>
        <field name="model">transport.booking</field>
        <field name="arch" type="xml">
            <tree string="R√©servations" decoration-muted="state in ['cancelled', 'expired', 'refunded']"
                  decoration-success="state == 'confirmed'"
                  decoration-warning="state == 'reserved'"
                  decoration-info="state == 'checked_in'"
                  decoration-bf="state == 'confirmed'"
                  multi_edit="1" sample="1">
                <field name="name" decoration-bf="1"/>
                <field name="trip_id" optional="show"/>
                <field name="route_id" optional="show"/>
                <field name="partner_id" optional="hide"/>
                <field name="passenger_name" decoration-bf="1"/>
                <field name="passenger_phone" widget="phone" optional="show"/>
                <field name="seat_number" decoration-bf="1" decoration-info="1"/>
                <field name="departure_datetime" widget="datetime"/>
                <field name="ticket_type" widget="badge"
                       decoration-success="ticket_type == 'adult'"
                       decoration-warning="ticket_type == 'child'"
                       decoration-info="ticket_type == 'vip'"/>
                <field name="total_amount" widget="monetary" sum="Total"/>
                <field name="amount_paid" widget="monetary" sum="Pay√©" optional="show"/>
                <field name="amount_due" widget="monetary" sum="Reste" optional="show"
                       decoration-danger="amount_due > 0"/>
                <field name="booking_type" widget="badge" optional="hide"
                       decoration-warning="booking_type == 'reservation'"
                       decoration-success="booking_type == 'purchase'"/>
                <field name="reservation_deadline" widget="remaining_days" optional="hide"
                       invisible="booking_type != 'reservation' or state != 'reserved'"/>
                <field name="state" widget="badge"
                       decoration-info="state == 'draft'"
                       decoration-warning="state == 'reserved'"
                       decoration-success="state == 'confirmed'"
                       decoration-primary="state == 'checked_in'"
                       decoration-muted="state in ['completed', 'cancelled', 'expired', 'refunded']"/>
                <field name="currency_id" column_invisible="1"/>
            </tree>
        </field>
    </record>

    <!-- Vue Form -->
    <record id="transport_booking_view_form" model="ir.ui.view">
        <field name="name">transport.booking.view.form</field>
        <field name="model">transport.booking</field>
        <field name="arch" type="xml">
            <form string="R√©servation">
                <header>
                    <button name="action_reserve" type="object" string="üé´ R√©server"
                            class="btn-warning" invisible="state != 'draft'"
                            data-hotkey="r" title="Cr√©er une r√©servation temporaire (24h max)"/>
                    <button name="action_confirm" type="object" string="‚úÖ Confirmer"
                            class="btn-success" invisible="state not in ['draft', 'reserved']"
                            data-hotkey="c" title="Confirmer apr√®s paiement"/>
                    <button name="action_check_in" type="object" string="üöå Embarquer"
                            class="btn-info" invisible="state != 'confirmed'"
                            data-hotkey="e"/>
                    <button name="action_cancel" type="object" string="‚ùå Annuler"
                            class="btn-danger" invisible="state in ['checked_in', 'completed', 'cancelled', 'expired', 'refunded']"
                            confirm="‚ö†Ô∏è √ätes-vous s√ªr de vouloir annuler cette r√©servation ? Le passager sera notifi√©."/>
                    <button name="action_print_ticket" type="object" string="üé´ Imprimer ticket"
                            class="btn-secondary" icon="fa-print" invisible="state not in ['confirmed', 'checked_in']"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,reserved,confirmed,checked_in,completed"/>
                </header>
                <sheet>
                    <widget name="web_ribbon" title="üö´ ANNUL√â" bg_color="bg-danger"
                            invisible="state != 'cancelled'"/>
                    <widget name="web_ribbon" title="‚è∞ EXPIR√â" bg_color="bg-secondary"
                            invisible="state != 'expired'"/>
                    <widget name="web_ribbon" title="üí∞ REMBOURS√â" bg_color="bg-info"
                            invisible="state != 'refunded'"/>
                    <widget name="web_ribbon" title="‚úÖ EMBARQU√â" bg_color="bg-success"
                            invisible="state != 'checked_in'"/>
                    
                    <div class="oe_button_box" name="button_box">
                        <button class="oe_stat_button" icon="fa-qrcode" invisible="not qr_code" disabled="1">
                            <span class="o_stat_text">QR Code</span>
                        </button>
                        <button name="action_print_ticket" type="object" class="oe_stat_button" 
                                icon="fa-print" invisible="state not in ['confirmed', 'checked_in']">
                            <span class="o_stat_text">Ticket PDF</span>
                        </button>
                    </div>
                    
                    <div class="oe_title">
                        <label for="name" string="R√©servation"/>
                        <h1>
                            <field name="name" readonly="1" class="text-primary"/>
                        </h1>
                    </div>
                    
                    <!-- Alertes contextuelles -->
                    <div class="alert alert-warning mb-3" role="alert" 
                         invisible="state != 'reserved' or not reservation_deadline">
                        <i class="fa fa-clock-o"/> <strong>R√©servation temporaire !</strong> 
                        Paiement requis avant: <field name="reservation_deadline" widget="datetime" readonly="1" nolabel="1"/>
                    </div>
                    <div class="alert alert-danger mb-3" role="alert" 
                         invisible="amount_due == 0 or state not in ['draft', 'reserved']">
                        <i class="fa fa-exclamation-triangle"/> <strong>Paiement en attente :</strong> 
                        <field name="amount_due" widget="monetary" readonly="1" nolabel="1"/> FCFA
                    </div>
                    <div class="alert alert-success mb-3" role="alert" 
                         invisible="state != 'confirmed'">
                        <i class="fa fa-check-circle"/> <strong>Ticket confirm√© !</strong> 
                        Le passager peut embarquer avec ce billet.
                    </div>
                    
                    <group>
                        <group string="üöå Voyage">
                            <field name="trip_id" readonly="state != 'draft'"
                                   options="{'no_create': True}"
                                   help="S√©lectionnez le voyage"/>
                            <field name="company_id" readonly="1"/>
                            <field name="route_id" readonly="1"/>
                            <field name="departure_datetime" readonly="1" widget="datetime"/>
                            <field name="bus_id" invisible="1"/>
                        </group>
                        <group string="üë§ Client">
                            <field name="partner_id" readonly="state not in ['draft', 'reserved']"
                                   options="{'no_create': False, 'no_quick_create': True}"/>
                            <field name="passenger_id" optional="hide"/>
                        </group>
                    </group>
                    <group>
                        <group string="üë§ Informations passager">
                            <field name="passenger_name" placeholder="Nom complet du passager"
                                   required="1"/>
                            <field name="passenger_phone" widget="phone" placeholder="+225 XX XX XX XX XX"
                                   help="Num√©ro pour les notifications"/>
                            <field name="passenger_email" widget="email" placeholder="email@exemple.ci"/>
                            <label for="passenger_id_type" string="Pi√®ce d'identit√©"/>
                            <div class="o_row">
                                <field name="passenger_id_type" placeholder="Type"/>
                                <field name="passenger_id_number" placeholder="Num√©ro"/>
                            </div>
                        </group>
                        <group string="üí∫ Si√®ge et billet">
                            <field name="seat_id" options="{'no_create': True}"
                                   help="S√©lectionnez un si√®ge sp√©cifique"/>
                            <field name="seat_number" invisible="1"/>
                            <field name="ticket_type" widget="radio" options="{'horizontal': true}"/>
                        </group>
                    </group>
                    <group>
                        <group string="üöè Points de trajet">
                            <field name="boarding_stop_id" options="{'no_create': True}"
                                   help="Arr√™t o√π le passager monte"/>
                            <field name="alighting_stop_id" options="{'no_create': True}"
                                   help="Arr√™t o√π le passager descend"/>
                        </group>
                        <group string="‚Ü©Ô∏è Aller-retour" invisible="not is_round_trip">
                            <field name="is_round_trip"/>
                            <field name="return_trip_id" invisible="not is_round_trip"/>
                            <field name="return_booking_id" invisible="not is_round_trip"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="üí∞ Tarification" name="pricing">
                            <group>
                                <group string="Prix du billet">
                                    <field name="ticket_price" widget="monetary" readonly="1"/>
                                    <field name="luggage_extra_price" widget="monetary" readonly="1"/>
                                    <field name="reservation_fee" widget="monetary" readonly="1"
                                           invisible="booking_type != 'reservation'"/>
                                    <label for="total_amount" string="Total √† payer"/>
                                    <h2 class="text-primary">
                                        <field name="total_amount" widget="monetary" nolabel="1"/>
                                    </h2>
                                    <field name="currency_id" invisible="1"/>
                                </group>
                                <group string="√âtat du paiement">
                                    <field name="amount_paid" widget="monetary"
                                           decoration-success="amount_due == 0"/>
                                    <label for="amount_due" string="Reste √† payer"/>
                                    <h3 class="text-danger" invisible="amount_due == 0">
                                        <field name="amount_due" widget="monetary" nolabel="1"
                                               decoration-danger="amount_due > 0"/>
                                    </h3>
                                    <span invisible="amount_due != 0"/>
                                    <span class="text-success fw-bold" invisible="amount_due != 0">
                                        <i class="fa fa-check-circle"/> Pay√© int√©gralement
                                    </span>
                                    <field name="booking_type" widget="badge"
                                           decoration-warning="booking_type == 'reservation'"
                                           decoration-success="booking_type == 'purchase'"/>
                                    <field name="reservation_deadline" widget="remaining_days" 
                                           invisible="booking_type != 'reservation'"
                                           help="Date limite pour confirmer la r√©servation"/>
                                </group>
                            </group>
                        </page>
                        <page string="üß≥ Bagages" name="luggage">
                            <div class="alert alert-info mb-3" role="alert">
                                <i class="fa fa-info-circle"/> <strong>Franchise bagage :</strong> 
                                20 kg inclus. Au-del√†, frais suppl√©mentaires appliqu√©s.
                            </div>
                            <group>
                                <group string="D√©tails bagages">
                                    <field name="luggage_type" widget="radio" 
                                           options="{'horizontal': true}"/>
                                    <field name="luggage_count"/>
                                    <field name="luggage_weight" help="Poids total en kg"/>
                                </group>
                                <group string="Frais suppl√©mentaires">
                                    <field name="luggage_extra_kg" readonly="1"
                                           decoration-danger="luggage_extra_kg > 0"/>
                                    <field name="luggage_extra_price" widget="monetary" readonly="1"
                                           decoration-danger="luggage_extra_price > 0"/>
                                </group>
                            </group>
                        </page>
                        <page string="üí≥ Paiement" name="payment">
                            <group>
                                <group string="Dernier paiement">
                                    <field name="payment_method" widget="badge"/>
                                    <field name="payment_reference" readonly="1"/>
                                    <field name="payment_date" widget="datetime" readonly="1"/>
                                </group>
                            </group>
                            <separator string="Historique des paiements"/>
                            <field name="payment_ids" readonly="1">
                                <tree decoration-success="state == 'confirmed'"
                                      decoration-warning="state == 'pending'"
                                      decoration-muted="state == 'cancelled'">
                                    <field name="name" decoration-bf="1"/>
                                    <field name="payment_method" widget="badge"/>
                                    <field name="amount" widget="monetary" sum="Total"/>
                                    <field name="payment_date" widget="datetime"/>
                                    <field name="state" widget="badge"
                                           decoration-success="state == 'confirmed'"
                                           decoration-warning="state == 'pending'"/>
                                </tree>
                            </field>
                        </page>
                        <page string="üé´ Ticket" name="ticket" 
                              invisible="state not in ['confirmed', 'checked_in']">
                            <div class="alert alert-success mb-3" role="alert">
                                <i class="fa fa-qrcode"/> Ce ticket est valide. 
                                Pr√©sentez-le √† l'embarquement.
                            </div>
                            <group>
                                <group string="Informations ticket">
                                    <field name="ticket_token" readonly="1" string="Code unique"/>
                                    <button name="action_print_ticket" type="object" 
                                            string="üìÑ T√©l√©charger PDF" class="btn-primary"
                                            icon="fa-download"/>
                                </group>
                                <group string="QR Code" class="text-center">
                                    <field name="qr_code" widget="image" 
                                           class="img-thumbnail" style="max-width: 200px;"/>
                                </group>
                            </group>
                        </page>
                        <page string="‚≠ê √âvaluation" name="rating" 
                              invisible="state != 'completed'">
                            <div class="alert alert-info mb-3" role="alert">
                                <i class="fa fa-star"/> Votre avis nous aide √† am√©liorer nos services !
                            </div>
                            <group>
                                <label for="rating" string="Note du voyage"/>
                                <field name="rating" widget="priority" nolabel="1"/>
                                <field name="rating_comment" widget="html" 
                                       placeholder="Partagez votre exp√©rience de voyage..."/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- Vue Kanban -->
    <record id="transport_booking_view_kanban" model="ir.ui.view">
        <field name="name">transport.booking.view.kanban</field>
        <field name="model">transport.booking</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile" default_group_by="state" sample="1"
                    quick_create="false" records_draggable="false">
                <field name="name"/>
                <field name="partner_id"/>
                <field name="passenger_name"/>
                <field name="passenger_phone"/>
                <field name="trip_id"/>
                <field name="route_id"/>
                <field name="departure_datetime"/>
                <field name="seat_number"/>
                <field name="ticket_type"/>
                <field name="total_amount"/>
                <field name="amount_paid"/>
                <field name="amount_due"/>
                <field name="state"/>
                <field name="currency_id"/>
                <progressbar field="state"
                    colors='{"draft": "muted", "reserved": "warning", "confirmed": "success", "checked_in": "info", "completed": "secondary", "cancelled": "danger", "expired": "muted", "refunded": "muted"}'/>
                <templates>
                    <t t-name="kanban-box">
                        <div t-attf-class="oe_kanban_global_click #{record.amount_due.raw_value > 0 ? 'border-warning' : ''} #{record.state.raw_value == 'confirmed' ? 'border-success' : ''}">
                            <div class="oe_kanban_details p-2">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong class="o_kanban_record_title text-primary">
                                        <i class="fa fa-ticket me-1"/><field name="name"/>
                                    </strong>
                                    <span t-attf-class="badge #{record.ticket_type.raw_value == 'vip' ? 'bg-info' : record.ticket_type.raw_value == 'child' ? 'bg-warning' : 'bg-secondary'}">
                                        <field name="ticket_type"/>
                                    </span>
                                </div>
                                <div class="mb-1">
                                    <i class="fa fa-user text-muted me-1"/>
                                    <strong><field name="passenger_name"/></strong>
                                </div>
                                <div class="text-muted small mb-1">
                                    <i class="fa fa-phone me-1"/>
                                    <field name="passenger_phone" widget="phone"/>
                                </div>
                                <div class="mb-1">
                                    <i class="fa fa-bus me-1"/>
                                    <field name="trip_id"/> 
                                </div>
                                <div class="text-muted small mb-1">
                                    <i class="fa fa-road me-1"/>
                                    <field name="route_id"/>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>
                                        <i class="fa fa-calendar me-1"/>
                                        <field name="departure_datetime" widget="date"/>
                                    </span>
                                    <span class="badge bg-primary">
                                        <i class="fa fa-chair me-1"/>Si√®ge <field name="seat_number"/>
                                    </span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center pt-2 border-top">
                                    <div>
                                        <span class="fw-bold text-success">
                                            <field name="total_amount" widget="monetary"/>
                                        </span>
                                        <t t-if="record.amount_due.raw_value > 0">
                                            <br/>
                                            <small class="text-danger">
                                                <i class="fa fa-exclamation-triangle"/>
                                                Reste: <field name="amount_due" widget="monetary"/>
                                            </small>
                                        </t>
                                    </div>
                                    <field name="state" widget="label_selection" 
                                           options="{'classes': {'draft': 'secondary', 'reserved': 'warning', 'confirmed': 'success', 'checked_in': 'info', 'completed': 'secondary', 'cancelled': 'danger'}}"/>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Vue Search am√©lior√©e -->
    <record id="transport_booking_view_search" model="ir.ui.view">
        <field name="name">transport.booking.view.search</field>
        <field name="model">transport.booking</field>
        <field name="arch" type="xml">
            <search string="üîç Rechercher une r√©servation">
                <field name="name" string="R√©f√©rence"
                       filter_domain="[('name', 'ilike', self)]"/>
                <field name="partner_id"/>
                <field name="passenger_name" string="Passager"
                       filter_domain="['|', ('passenger_name', 'ilike', self), ('passenger_phone', 'ilike', self)]"/>
                <field name="passenger_phone"/>
                <field name="passenger_email"/>
                <field name="trip_id"/>
                <field name="route_id"/>
                <field name="company_id" groups="transport_interurbain.group_transport_manager"/>
                <field name="seat_number"/>
                
                <separator/>
                <filter string="üìÖ Aujourd'hui" name="today" 
                        domain="[('departure_datetime', '>=', context_today().strftime('%Y-%m-%d')), ('departure_datetime', '&lt;', (context_today() + datetime.timedelta(days=1)).strftime('%Y-%m-%d'))]"/>
                <filter string="üìÖ Demain" name="tomorrow"
                        domain="[('departure_datetime', '>=', (context_today() + datetime.timedelta(days=1)).strftime('%Y-%m-%d')), ('departure_datetime', '&lt;', (context_today() + datetime.timedelta(days=2)).strftime('%Y-%m-%d'))]"/>
                <filter string="üìÖ Cette semaine" name="this_week"
                        domain="[('departure_datetime', '>=', (context_today() - datetime.timedelta(days=context_today().weekday())).strftime('%Y-%m-%d')), ('departure_datetime', '&lt;', (context_today() + datetime.timedelta(days=7-context_today().weekday())).strftime('%Y-%m-%d'))]"/>
                <filter string="üìÖ Ce mois" name="this_month" 
                        domain="[('departure_datetime', '>=', context_today().strftime('%Y-%m-01'))]"/>
                <separator/>
                
                <filter string="‚è≥ En attente" name="pending" 
                        domain="[('state', 'in', ['draft', 'reserved'])]"/>
                <filter string="‚úÖ Confirm√©es" name="confirmed" 
                        domain="[('state', '=', 'confirmed')]"/>
                <filter string="üöå Embarqu√©es" name="checked_in" 
                        domain="[('state', '=', 'checked_in')]"/>
                <filter string="‚úîÔ∏è Termin√©es" name="completed" 
                        domain="[('state', '=', 'completed')]"/>
                <filter string="‚ùå Annul√©es" name="cancelled" 
                        domain="[('state', 'in', ['cancelled', 'expired', 'refunded'])]"/>
                <separator/>
                
                <filter string="üí∞ Non pay√©es" name="unpaid" 
                        domain="[('amount_due', '>', 0)]"/>
                <filter string="‚úÖ Pay√©es" name="paid" 
                        domain="[('amount_due', '=', 0), ('state', 'not in', ['draft', 'cancelled'])]"/>
                <filter string="‚è∞ √Ä expirer bient√¥t" name="expiring" 
                        domain="[('state', '=', 'reserved'), ('reservation_deadline', '&lt;=', (context_today() + datetime.timedelta(hours=2)).strftime('%Y-%m-%d %H:%M:%S'))]"/>
                <separator/>
                
                <filter string="üëë VIP" name="vip" 
                        domain="[('ticket_type', '=', 'vip')]"/>
                <filter string="üë∂ Enfants" name="children" 
                        domain="[('ticket_type', '=', 'child')]"/>
                <filter string="‚Ü©Ô∏è Aller-retour" name="round_trip" 
                        domain="[('is_round_trip', '=', True)]"/>
                
                <group expand="1" string="üìä Grouper par">
                    <filter string="Voyage" name="trip" icon="fa-bus"
                            context="{'group_by': 'trip_id'}"/>
                    <filter string="Itin√©raire" name="route" icon="fa-road"
                            context="{'group_by': 'route_id'}"/>
                    <filter string="Compagnie" name="company" icon="fa-building"
                            context="{'group_by': 'company_id'}"/>
                    <filter string="Date d√©part" name="date" icon="fa-calendar"
                            context="{'group_by': 'departure_datetime:day'}"/>
                    <filter string="Mois" name="month" icon="fa-calendar-o"
                            context="{'group_by': 'departure_datetime:month'}"/>
                    <filter string="√âtat" name="state" icon="fa-flag"
                            context="{'group_by': 'state'}"/>
                    <filter string="Type billet" name="ticket_type" icon="fa-ticket"
                            context="{'group_by': 'ticket_type'}"/>
                    <filter string="Mode paiement" name="payment_method" icon="fa-credit-card"
                            context="{'group_by': 'payment_method'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Action principale am√©lior√©e -->
    <record id="transport_booking_action" model="ir.actions.act_window">
        <field name="name">üé´ R√©servations</field>
        <field name="res_model">transport.booking</field>
        <field name="view_mode">tree,kanban,form,pivot,graph</field>
        <field name="search_view_id" ref="transport_booking_view_search"/>
        <field name="context">{'search_default_pending': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Cr√©er une nouvelle r√©servation
            </p>
            <p>
                G√©rez les r√©servations et ventes de tickets pour vos voyages interurbains.
                <br/>
                <b>Astuce :</b> Utilisez les filtres pour retrouver rapidement une r√©servation.
            </p>
        </field>
    </record>

    <!-- Action pour r√©servations du jour -->
    <record id="transport_booking_today_action" model="ir.actions.act_window">
        <field name="name">üé´ R√©servations du jour</field>
        <field name="res_model">transport.booking</field>
        <field name="view_mode">tree,kanban,form</field>
        <field name="search_view_id" ref="transport_booking_view_search"/>
        <field name="context">{'search_default_today': 1}</field>
    </record>
    
    <!-- Action pour r√©servations non pay√©es -->
    <record id="transport_booking_unpaid_action" model="ir.actions.act_window">
        <field name="name">üí∞ R√©servations impay√©es</field>
        <field name="res_model">transport.booking</field>
        <field name="view_mode">tree,form</field>
        <field name="search_view_id" ref="transport_booking_view_search"/>
        <field name="domain">[('amount_due', '>', 0), ('state', 'not in', ['cancelled', 'expired', 'refunded'])]</field>
    </record>

</odoo>
