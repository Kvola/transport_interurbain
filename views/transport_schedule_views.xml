<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ==================== TRIP SCHEDULE VIEWS ==================== -->

    <!-- Schedule Tree View -->
    <record id="transport_trip_schedule_view_tree" model="ir.ui.view">
        <field name="name">transport.trip.schedule.view.tree</field>
        <field name="model">transport.trip.schedule</field>
        <field name="arch" type="xml">
            <tree string="Programmes de voyages" decoration-muted="state=='archived'" decoration-info="state=='draft'">
                <field name="name"/>
                <field name="company_id"/>
                <field name="route_id"/>
                <field name="default_bus_id"/>
                <field name="default_price" widget="monetary"/>
                <field name="date_start"/>
                <field name="date_end"/>
                <field name="line_ids" widget="many2many_tags" string="Horaires"/>
                <field name="generated_trips_count"/>
                <field name="state" widget="badge" decoration-success="state == 'active'" decoration-info="state == 'draft'" decoration-muted="state == 'archived'"/>
            </tree>
        </field>
    </record>

    <!-- Schedule Form View -->
    <record id="transport_trip_schedule_view_form" model="ir.ui.view">
        <field name="name">transport.trip.schedule.view.form</field>
        <field name="model">transport.trip.schedule</field>
        <field name="arch" type="xml">
            <form string="Programme de voyage">
                <header>
                    <button name="action_activate" type="object" string="Activer" class="btn-primary" invisible="state != 'draft'"/>
                    <button name="action_draft" type="object" string="Repasser en brouillon" invisible="state != 'archived'"/>
                    <button name="action_archive" type="object" string="Archiver" invisible="state != 'active'"/>
                    <button name="action_generate_trips_wizard" type="object" string="Générer des voyages" class="btn-secondary" icon="fa-magic" invisible="state != 'active'"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,active"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_trips" type="object" class="oe_stat_button" icon="fa-bus" invisible="generated_trips_count == 0">
                            <field name="generated_trips_count" widget="statinfo" string="Voyages"/>
                        </button>
                    </div>
                    <div class="oe_title">
                        <h1>
                            <field name="name" placeholder="Nom du programme"/>
                        </h1>
                    </div>
                    <group>
                        <group string="Configuration générale">
                            <field name="company_id" options="{'no_create': True}"/>
                            <field name="route_id" options="{'no_create': True}"/>
                            <field name="default_bus_id" options="{'no_create': True}" domain="[('company_id', '=', company_id)]"/>
                            <field name="meeting_point"/>
                        </group>
                        <group string="Tarification">
                            <field name="default_price" widget="monetary"/>
                            <field name="currency_id" invisible="1"/>
                            <field name="default_vip_price" widget="monetary"/>
                            <field name="default_child_price" widget="monetary"/>
                        </group>
                    </group>
                    <group>
                        <group string="Période de validité">
                            <field name="date_start"/>
                            <field name="date_end"/>
                        </group>
                        <group string="Jours d'opération">
                            <div class="d-flex flex-wrap">
                                <div class="me-4">
                                    <field name="monday" class="oe_inline"/>
                                    <label for="monday" string="Lundi" class="ms-1"/>
                                </div>
                                <div class="me-4">
                                    <field name="tuesday" class="oe_inline"/>
                                    <label for="tuesday" string="Mardi" class="ms-1"/>
                                </div>
                                <div class="me-4">
                                    <field name="wednesday" class="oe_inline"/>
                                    <label for="wednesday" string="Mercredi" class="ms-1"/>
                                </div>
                                <div class="me-4">
                                    <field name="thursday" class="oe_inline"/>
                                    <label for="thursday" string="Jeudi" class="ms-1"/>
                                </div>
                                <div class="me-4">
                                    <field name="friday" class="oe_inline"/>
                                    <label for="friday" string="Vendredi" class="ms-1"/>
                                </div>
                                <div class="me-4">
                                    <field name="saturday" class="oe_inline"/>
                                    <label for="saturday" string="Samedi" class="ms-1"/>
                                </div>
                                <div class="me-4">
                                    <field name="sunday" class="oe_inline"/>
                                    <label for="sunday" string="Dimanche" class="ms-1"/>
                                </div>
                            </div>
                        </group>
                    </group>
                    <notebook>
                        <page string="Horaires de départ" name="lines">
                            <field name="line_ids">
                                <tree string="Horaires" editable="bottom">
                                    <field name="sequence" widget="handle"/>
                                    <field name="departure_hour" widget="float_time"/>
                                    <field name="label"/>
                                    <field name="bus_id" optional="hide" domain="[('company_id', '=', parent.company_id)]"/>
                                    <field name="driver_name" optional="hide"/>
                                    <field name="price" optional="hide" widget="monetary"/>
                                    <field name="currency_id" column_invisible="1"/>
                                    <field name="active"/>
                                </tree>
                            </field>
                            <div class="alert alert-info" role="alert">
                                <i class="fa fa-info-circle"/> Pour chaque horaire, vous pouvez optionnellement spécifier un bus et un chauffeur différents du défaut.
                            </div>
                        </page>
                        <page string="Notes" name="notes">
                            <field name="notes" placeholder="Notes internes..."/>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- Schedule Search View -->
    <record id="transport_trip_schedule_view_search" model="ir.ui.view">
        <field name="name">transport.trip.schedule.view.search</field>
        <field name="model">transport.trip.schedule</field>
        <field name="arch" type="xml">
            <search string="Rechercher programmes">
                <field name="name"/>
                <field name="company_id"/>
                <field name="route_id"/>
                <separator/>
                <filter name="filter_draft" string="Brouillon" domain="[('state', '=', 'draft')]"/>
                <filter name="filter_active" string="Actif" domain="[('state', '=', 'active')]"/>
                <filter name="filter_archived" string="Archivé" domain="[('state', '=', 'archived')]"/>
                <separator/>
                <filter name="filter_weekdays" string="Jours ouvrés" domain="[('monday', '=', True), ('friday', '=', True)]"/>
                <filter name="filter_weekend" string="Week-end inclus" domain="['|', ('saturday', '=', True), ('sunday', '=', True)]"/>
                <separator/>
                <group expand="0" string="Grouper par">
                    <filter name="group_company" string="Compagnie" context="{'group_by': 'company_id'}"/>
                    <filter name="group_route" string="Itinéraire" context="{'group_by': 'route_id'}"/>
                    <filter name="group_state" string="État" context="{'group_by': 'state'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Schedule Calendar View -->
    <record id="transport_trip_schedule_view_calendar" model="ir.ui.view">
        <field name="name">transport.trip.schedule.view.calendar</field>
        <field name="model">transport.trip.schedule</field>
        <field name="arch" type="xml">
            <calendar string="Programmes" date_start="date_start" date_stop="date_end" color="company_id" mode="month">
                <field name="name"/>
                <field name="route_id"/>
                <field name="company_id"/>
            </calendar>
        </field>
    </record>

    <!-- Schedule Action -->
    <record id="transport_trip_schedule_action" model="ir.actions.act_window">
        <field name="name">Programmes de voyages</field>
        <field name="res_model">transport.trip.schedule</field>
        <field name="view_mode">tree,form,calendar</field>
        <field name="search_view_id" ref="transport_trip_schedule_view_search"/>
        <field name="context">{'search_default_filter_active': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Créez votre premier programme de voyage
            </p>
            <p>
                Les programmes vous permettent de définir des voyages récurrents avec leurs horaires et tarifs,
                puis de générer automatiquement les voyages pour une période donnée.
            </p>
        </field>
    </record>

    <!-- ==================== WIZARD VIEWS ==================== -->

    <!-- Trip Generate Wizard Form -->
    <record id="transport_trip_generate_wizard_view_form" model="ir.ui.view">
        <field name="name">transport.trip.generate.wizard.view.form</field>
        <field name="model">transport.trip.generate.wizard</field>
        <field name="arch" type="xml">
            <form string="Générer des voyages">
                <group>
                    <group string="Programme">
                        <field name="schedule_id" readonly="1"/>
                        <field name="company_id" readonly="1"/>
                        <field name="route_id" readonly="1"/>
                        <field name="operating_days_display" string="Jours d'opération" readonly="1"/>
                    </group>
                    <group string="Période de génération">
                        <field name="date_from"/>
                        <field name="date_to"/>
                        <field name="skip_existing"/>
                    </group>
                </group>
                <group>
                    <div class="alert alert-info text-center" role="alert">
                        <h4 class="mb-0">
                            <i class="fa fa-calendar me-2"/>
                            <field name="days_count" readonly="1" class="oe_inline"/> jours d'opération →
                            <strong><field name="estimated_trips" readonly="1" class="oe_inline"/> voyages</strong> seront générés
                        </h4>
                    </div>
                </group>
                <footer>
                    <button name="action_generate" type="object" string="Générer les voyages" class="btn-primary"/>
                    <button name="action_preview" type="object" string="Aperçu" class="btn-secondary"/>
                    <button string="Annuler" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- Wizard Action (called from schedule) -->
    <record id="transport_trip_generate_wizard_action" model="ir.actions.act_window">
        <field name="name">Générer des voyages</field>
        <field name="res_model">transport.trip.generate.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
    </record>

    <!-- ==================== SCHEDULE LINE VIEWS (optional, for debugging) ==================== -->

    <record id="transport_trip_schedule_line_view_tree" model="ir.ui.view">
        <field name="name">transport.trip.schedule.line.view.tree</field>
        <field name="model">transport.trip.schedule.line</field>
        <field name="arch" type="xml">
            <tree string="Horaires">
                <field name="sequence" widget="handle"/>
                <field name="schedule_id"/>
                <field name="departure_hour" widget="float_time"/>
                <field name="label"/>
                <field name="bus_id"/>
                <field name="driver_name"/>
                <field name="price" widget="monetary"/>
                <field name="active"/>
            </tree>
        </field>
    </record>

</odoo>
