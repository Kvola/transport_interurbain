<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ============================================ -->
    <!-- VUES POUR LES VOYAGES -->
    <!-- ============================================ -->

    <!-- Vue Tree -->
    <record id="transport_trip_view_tree" model="ir.ui.view">
        <field name="name">transport.trip.view.tree</field>
        <field name="model">transport.trip</field>
        <field name="arch" type="xml">
            <tree string="Voyages" decoration-muted="state in ['cancelled', 'arrived']"
                  decoration-success="state == 'scheduled' and available_seats > 10"
                  decoration-warning="state == 'scheduled' and available_seats &lt;= 10 and available_seats > 0"
                  decoration-danger="state == 'scheduled' and available_seats == 0"
                  decoration-info="state == 'boarding'"
                  multi_edit="1" sample="1">
                <field name="name" decoration-bf="1"/>
                <field name="company_id" optional="show"/>
                <field name="route_id"/>
                <field name="bus_id" optional="show"/>
                <field name="departure_datetime" widget="datetime"/>
                <field name="meeting_point" optional="hide"/>
                <field name="price" widget="monetary"/>
                <field name="total_seats" optional="hide"/>
                <field name="booking_quota" optional="hide"/>
                <field name="effective_quota" optional="hide"/>
                <field name="booked_seats" decoration-bf="1"/>
                <field name="available_seats" decoration-bf="1" decoration-success="available_seats > 10" 
                       decoration-warning="available_seats &lt;= 10 and available_seats > 0"
                       decoration-danger="available_seats == 0"/>
                <field name="occupancy_rate" widget="progressbar" 
                       options="{'editable': false, 'max_value': 100}"/>
                <field name="is_published" widget="boolean_toggle" optional="hide"/>
                <field name="state" widget="badge"
                       decoration-info="state == 'draft'"
                       decoration-success="state == 'scheduled'"
                       decoration-primary="state == 'boarding'"
                       decoration-warning="state == 'departed'"
                       decoration-muted="state in ['arrived', 'cancelled']"/>
                <field name="currency_id" column_invisible="1"/>
            </tree>
        </field>
    </record>

    <!-- Vue Form -->
    <record id="transport_trip_view_form" model="ir.ui.view">
        <field name="name">transport.trip.view.form</field>
        <field name="model">transport.trip</field>
        <field name="arch" type="xml">
            <form string="Voyage">
                <header>
                    <button name="action_schedule" type="object" string="Programmer"
                            class="btn-primary" invisible="state != 'draft'"
                            data-hotkey="p" title="Programmer ce voyage pour le rendre disponible aux r√©servations"/>
                    <button name="action_start_boarding" type="object" string="D√©marrer embarquement"
                            class="btn-info" invisible="state != 'scheduled'"
                            data-hotkey="b" title="Ouvrir l'embarquement des passagers"/>
                    <button name="action_depart" type="object" string="D√©part"
                            class="btn-warning" invisible="state not in ['scheduled', 'boarding']"
                            confirm="Confirmer le d√©part du voyage ? Les r√©servations non confirm√©es seront expir√©es."
                            data-hotkey="d"/>
                    <button name="action_arrive" type="object" string="Arriv√©e"
                            class="btn-success" invisible="state != 'departed'"
                            data-hotkey="a"/>
                    <button name="action_cancel" type="object" string="Annuler"
                            class="btn-danger" invisible="state in ['departed', 'arrived', 'cancelled']"
                            confirm="‚ö†Ô∏è ATTENTION: √ätes-vous s√ªr de vouloir annuler ce voyage ? Toutes les r√©servations seront annul√©es et les passagers notifi√©s."/>
                    <button name="action_reset_draft" type="object" string="‚Ü© Brouillon"
                            invisible="state not in ['cancelled', 'scheduled']"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,scheduled,boarding,departed,arrived"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_bookings" type="object"
                                class="oe_stat_button" icon="fa-ticket">
                            <div class="o_stat_info">
                                <span class="o_stat_value">
                                    <field name="booked_seats" nolabel="1"/>/<field name="total_seats" nolabel="1"/>
                                </span>
                                <span class="o_stat_text">R√©servations</span>
                            </div>
                        </button>
                        <button name="action_view_seat_map" type="object"
                                class="oe_stat_button" icon="fa-th">
                            <div class="o_stat_info">
                                <span class="o_stat_value text-success">
                                    <field name="available_seats" nolabel="1"/>
                                </span>
                                <span class="o_stat_text">Places libres</span>
                            </div>
                        </button>
                        <button class="oe_stat_button" icon="fa-percent" disabled="1">
                            <div class="o_stat_info">
                                <span class="o_stat_value">
                                    <field name="occupancy_rate" nolabel="1" widget="float" digits="[3,0]"/>%
                                </span>
                                <span class="o_stat_text">Remplissage</span>
                            </div>
                        </button>
                    </div>
                    <widget name="web_ribbon" title="üö´ ANNUL√â" bg_color="bg-danger"
                            invisible="state != 'cancelled'"/>
                    <widget name="web_ribbon" title="‚úÖ ARRIV√â" bg_color="bg-success"
                            invisible="state != 'arrived'"/>
                    <widget name="web_ribbon" title="üöå EN ROUTE" bg_color="bg-warning"
                            invisible="state != 'departed'"/>
                    <div class="oe_title">
                        <label for="name" string="Voyage"/>
                        <h1>
                            <field name="name" readonly="1" class="text-primary"/>
                        </h1>
                    </div>
                    
                    <!-- Alertes et informations -->
                    <div class="alert alert-warning mb-3" role="alert" invisible="state != 'draft'">
                        <i class="fa fa-info-circle"/> Ce voyage est en <strong>brouillon</strong>. Cliquez sur "Programmer" pour le rendre disponible aux r√©servations.
                    </div>
                    <div class="alert alert-danger mb-3" role="alert" invisible="available_seats != 0 or state not in ['scheduled', 'boarding']">
                        <i class="fa fa-exclamation-triangle"/> <strong>COMPLET !</strong> Ce voyage n'a plus de places disponibles.
                    </div>
                    <div class="alert alert-info mb-3" role="alert" invisible="available_seats > 5 or available_seats == 0 or state not in ['scheduled', 'boarding']">
                        <i class="fa fa-clock-o"/> <strong>Presque complet !</strong> Seulement <field name="available_seats" nolabel="1" readonly="1"/> place(s) restante(s).
                    </div>
                    
                    <group>
                        <group string="üöå Voyage">
                            <field name="company_id" readonly="state != 'draft'" widget="selection"
                                   options="{'no_create': True}"/>
                            <field name="route_id" readonly="state != 'draft'"
                                   options="{'no_create': True}"
                                   help="S√©lectionnez l'itin√©raire du voyage"/>
                            <field name="bus_id" readonly="state not in ['draft', 'scheduled']"
                                   options="{'no_create': True}"
                                   help="S√©lectionnez le bus assign√© √† ce voyage"/>
                            <label for="driver_name" string="Conducteur"/>
                            <div class="o_row">
                                <field name="driver_name" placeholder="Nom du chauffeur"/>
                                <field name="driver_phone" widget="phone" placeholder="T√©l√©phone"/>
                            </div>
                        </group>
                        <group string="üïê Horaires">
                            <field name="departure_datetime" readonly="state not in ['draft', 'scheduled']"
                                   widget="datetime" options="{'datepicker': {'warn_future': true}}"/>
                            <field name="arrival_datetime" widget="datetime"/>
                            <field name="departure_date" invisible="1"/>
                            <field name="actual_departure" readonly="1" invisible="not actual_departure"
                                   decoration-success="1"/>
                            <field name="actual_arrival" readonly="1" invisible="not actual_arrival"
                                   decoration-success="1"/>
                        </group>
                    </group>
                    <group>
                        <group string="üìç Lieu de rassemblement">
                            <field name="meeting_point" placeholder="Ex: Gare routi√®re d'Adjam√©"
                                   help="Lieu o√π les passagers doivent se retrouver"/>
                            <field name="meeting_point_address" placeholder="Adresse compl√®te..."/>
                            <field name="meeting_time_before" widget="integer"
                                   help="Temps recommand√© d'arriv√©e avant le d√©part"/>
                        </group>
                        <group string="üìä Disponibilit√©">
                            <field name="total_seats" readonly="1"/>
                            <field name="booking_quota" readonly="state not in ['draft', 'scheduled']"
                                   help="0 = pas de limite (capacit√© du bus)"/>
                            <field name="effective_quota" readonly="1" 
                                   decoration-info="booking_quota == 0"/>
                            <field name="booked_seats" readonly="1" decoration-bf="1"/>
                            <field name="available_seats" readonly="1" decoration-bf="1"
                                   decoration-success="available_seats > 10"
                                   decoration-warning="available_seats &lt;= 10 and available_seats > 0"
                                   decoration-danger="available_seats == 0"/>
                            <field name="occupancy_rate" widget="progressbar"
                                   options="{'editable': false, 'max_value': 100}"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="üí∞ Tarification" name="pricing">
                            <group>
                                <group string="Prix des billets">
                                    <field name="price" widget="monetary"
                                           help="Prix standard du billet"/>
                                    <field name="vip_price" widget="monetary"
                                           help="Prix pour les si√®ges VIP (doit √™tre sup√©rieur au prix normal)"/>
                                    <field name="child_price" widget="monetary"
                                           help="Prix pour les enfants de moins de 12 ans"/>
                                    <field name="currency_id" invisible="1"/>
                                </group>
                                <group string="Gestion des bagages">
                                    <field name="manage_luggage" widget="boolean_toggle"/>
                                    <field name="luggage_included_kg" invisible="not manage_luggage"
                                           help="Poids de bagages inclus dans le prix du billet"/>
                                    <field name="extra_luggage_price" invisible="not manage_luggage"
                                           help="Prix par kg suppl√©mentaire"/>
                                </group>
                            </group>
                        </page>
                        <page string="üöè Arr√™ts interm√©diaires" name="stops">
                            <field name="stop_times_ids" nolabel="1">
                                <tree editable="bottom" decoration-info="sequence == 1">
                                    <field name="sequence" widget="handle"/>
                                    <field name="city_id" decoration-bf="1"/>
                                    <field name="estimated_arrival" widget="datetime"/>
                                    <field name="actual_arrival" widget="datetime"/>
                                    <field name="stop_duration"/>
                                    <field name="price_from_start" widget="monetary"/>
                                    <field name="price_to_end" widget="monetary"/>
                                    <field name="boarding_count" decoration-success="boarding_count > 0"/>
                                    <field name="alighting_count" decoration-warning="alighting_count > 0"/>
                                    <field name="currency_id" column_invisible="1"/>
                                </tree>
                            </field>
                        </page>
                        <page string="‚öôÔ∏è Options" name="options">
                            <group>
                                <group string="Publication">
                                    <field name="is_published" widget="boolean_toggle"
                                           help="Rendre ce voyage visible sur le site web"/>
                                    <field name="is_recurring"/>
                                </group>
                                <group string="G√©olocalisation">
                                    <field name="meeting_point_latitude"/>
                                    <field name="meeting_point_longitude"/>
                                </group>
                            </group>
                            <separator string="Notes internes"/>
                            <field name="notes" placeholder="Notes internes (non visibles par les passagers)..."
                                   class="oe_inline"/>
                        </page>
                        <page string="‚ÑπÔ∏è Infos passagers" name="passenger_info">
                            <p class="text-muted mb-3">
                                <i class="fa fa-info-circle"/> Ces informations seront affich√©es aux passagers lors de la r√©servation.
                            </p>
                            <field name="passenger_info" placeholder="Ex: Pr√©voir une pi√®ce d'identit√© valide. Arriver 30 minutes avant le d√©part..."
                                   options="{'collaborative': true}"/>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- Vue Calendar -->
    <record id="transport_trip_view_calendar" model="ir.ui.view">
        <field name="name">transport.trip.view.calendar</field>
        <field name="model">transport.trip</field>
        <field name="arch" type="xml">
            <calendar string="Voyages" date_start="departure_datetime" date_stop="arrival_datetime"
                      color="company_id" mode="week" quick_create="0">
                <field name="name"/>
                <field name="route_id"/>
                <field name="bus_id"/>
                <field name="available_seats"/>
            </calendar>
        </field>
    </record>

    <!-- Vue Kanban -->
    <record id="transport_trip_view_kanban" model="ir.ui.view">
        <field name="name">transport.trip.view.kanban</field>
        <field name="model">transport.trip</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile" default_group_by="state">
                <field name="name"/>
                <field name="company_id"/>
                <field name="route_id"/>
                <field name="departure_datetime"/>
                <field name="available_seats"/>
                <field name="total_seats"/>
                <field name="price"/>
                <field name="state"/>
                <progressbar field="state"
                    colors='{"draft": "muted", "scheduled": "success", "boarding": "info", "departed": "warning", "arrived": "secondary", "cancelled": "danger"}'/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_global_click">
                            <div class="oe_kanban_details">
                                <strong class="o_kanban_record_title">
                                    <field name="name"/>
                                </strong>
                                <div class="text-muted">
                                    <field name="route_id"/>
                                </div>
                                <div>
                                    <i class="fa fa-calendar me-1"/>
                                    <field name="departure_datetime" widget="datetime"/>
                                </div>
                                <div class="mt-2">
                                    <span class="badge bg-primary">
                                        <field name="available_seats"/>/<field name="total_seats"/> places
                                    </span>
                                    <span class="badge bg-success ms-1">
                                        <field name="price" widget="monetary"/> FCFA
                                    </span>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Vue Search -->
    <record id="transport_trip_view_search" model="ir.ui.view">
        <field name="name">transport.trip.view.search</field>
        <field name="model">transport.trip</field>
        <field name="arch" type="xml">
            <search string="Rechercher un voyage">
                <field name="name"/>
                <field name="company_id"/>
                <field name="route_id"/>
                <field name="bus_id"/>
                <field name="driver_name"/>
                <filter string="Aujourd'hui" name="today" domain="[('departure_date', '=', context_today().strftime('%Y-%m-%d'))]"/>
                <filter string="Cette semaine" name="week" domain="[('departure_date', '>=', (context_today() - datetime.timedelta(days=context_today().weekday())).strftime('%Y-%m-%d')), ('departure_date', '&lt;', (context_today() + datetime.timedelta(days=7-context_today().weekday())).strftime('%Y-%m-%d'))]"/>
                <separator/>
                <filter string="Programm√©s" name="scheduled" domain="[('state', '=', 'scheduled')]"/>
                <filter string="En cours" name="in_progress" domain="[('state', 'in', ['boarding', 'departed'])]"/>
                <filter string="Termin√©s" name="arrived" domain="[('state', '=', 'arrived')]"/>
                <separator/>
                <filter string="Avec places" name="available" domain="[('available_seats', '>', 0)]"/>
                <filter string="Complet" name="full" domain="[('available_seats', '=', 0)]"/>
                <group expand="0" string="Grouper par">
                    <filter string="Compagnie" name="company" context="{'group_by': 'company_id'}"/>
                    <filter string="Itin√©raire" name="route" context="{'group_by': 'route_id'}"/>
                    <filter string="Date" name="date" context="{'group_by': 'departure_date'}"/>
                    <filter string="√âtat" name="state" context="{'group_by': 'state'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Action principale -->
    <record id="transport_trip_action" model="ir.actions.act_window">
        <field name="name">Voyages</field>
        <field name="res_model">transport.trip</field>
        <field name="view_mode">tree,kanban,calendar,form</field>
        <field name="search_view_id" ref="transport_trip_view_search"/>
        <field name="context">{'search_default_scheduled': 1, 'search_default_today': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Programmer un nouveau voyage
            </p>
            <p>
                Planifiez les voyages sur les diff√©rents itin√©raires.
            </p>
        </field>
    </record>

    <!-- Action pour voyages du jour -->
    <record id="transport_trip_today_action" model="ir.actions.act_window">
        <field name="name">Voyages du jour</field>
        <field name="res_model">transport.trip</field>
        <field name="view_mode">tree,kanban,form</field>
        <field name="search_view_id" ref="transport_trip_view_search"/>
        <field name="domain">[('departure_date', '=', context_today().strftime('%Y-%m-%d'))]</field>
        <field name="context">{'search_default_scheduled': 1}</field>
    </record>

</odoo>
